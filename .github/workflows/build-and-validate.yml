name: Build and Validate

on:
    workflow_call:

env:
    HUSKY: 0 # Skip git hooks in CI

jobs:
    build-and-validate:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup AWS SAM CLI
              uses: aws-actions/setup-sam@v2
              with:
                  use-installer: true

            - name: SAM validate
              run: sam validate --lint

            - name: SAM build
              run: sam build

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-1

            - name: Validate changeset (dry-run)
              run: |
                  set -o pipefail
                  sam deploy --no-execute-changeset --no-fail-on-empty-changeset 2>&1 | tee /tmp/changeset.log
                  if grep -q "Failed to create changeset" /tmp/changeset.log; then
                    echo "::error::Changeset validation failed"
                    exit 1
                  fi
